# chinese-llama-tokenizer

## 简介

### tokenizer-compatible

以LLaMA-2的词表为基础，结合Baichuan对词表进行了扩充，提高中文编码效率。

扩充后词表大小为57581，其中：

- 汉字21108个
- 词语5156条

1. 优点：兼容LLaMA，并支持更多中文
2. 用法：替换原来的分词器，并用中文语料增量训练LLaMA

### tokenizer-human

重头设计词表，以人类规范收录字词。

词表大小为41921，包含：

- 简体字（8106个）
- 繁体字（2361个）
- 词语（17000条）
- 英文词根词缀
- 英文词汇
- 编程语言关键字
- 其它（日文假名、数学符号等）

1. 优点：小而美，支持中英日三国语言和数门编程语言
2. 用法：重头训练LLM

## 效果

针对以下文本进行分词（运行test_tokenizer.py）：

```
<s>    test    </s>
### 登鹳雀楼
白日依山尽，黄河入海流。欲穷千里目，更上一层楼。
白日は山に沿って尽き、黄河は海に流れ込む。千里の眺めを求めるなら、もう一層の楼に上がれ。
The sun beyond the mountain glows. The Yellow River seaward flows. You can enjoy a grander sight. By climbing to a greater height.
if __name__ == '__main__':
public static void main(String[] args) {
<body><h1>标题一</h1><h2>标题二</h2><p>段落</p></body>
cos2α=2cos²α−1
f(b)−f(a)=f′(ξ)(b−a),ξ∈(a,b)
...
```

结果：

```python
['\n', '<', 's', '>', '▁▁▁', '▁test', '▁▁▁▁', '</', 's', '>', '\n', '###', '▁', '登', '鹳', '雀', '楼', '\n', '白日',
 '依', '山', '尽', ',', '黄河', '入', '海', '流', '。', '欲', '穷', '千', '里', '目', ',', '更', '上', '一', '层', '楼',
 '。', '\n', '白日', 'は', '山', 'に', '沿', 'っ', 'て', '尽', 'き', '、', '黄河', 'は', '海', 'に', '流', 'れ', '<0xE8>',
 '<0xBE>', '<0xBC>', 'む', '。', '千', '里', 'の', '眺', 'め', 'を', '求', 'め', 'る', 'な', 'ら', '、', 'も', 'う', '一', '層',
 'の', '楼', 'に', '上', 'が', 'れ', '。', '\n', 'The', '▁sun', '▁beyond', '▁the', '▁mountain', '▁glow', 's', '.', '▁',
 'The', '▁', 'Yellow', '▁', 'River', '▁sea', 'ward', '▁flow', 's', '.', '▁', 'You', '▁can', '▁enjoy', '▁a', '▁grand',
 'er', '▁sight', '.', '▁', 'By', '▁climb', 'ing', '▁to', '▁a', '▁great', 'er', '▁height', '.', '\n', 'if', '▁', '__',
 'name', '__', '▁', '==', '▁', "'", '__', 'main', '__', "'", ':', '\n', 'public', '▁static', '▁void', '▁main', '(',
 'String', '[]', '▁ar', 'g', 's', ')', '▁', '{', '\n', '<', 'body', '>', '<', 'h', '1', '>', '标题', '一', '</', 'h',
 '1', '>', '<', 'h', '2', '>', '标题', '二', '</', 'h', '2', '>', '<', 'p', '>', '段落', '</', 'p', '>', '</', 'body',
 '>', '\n', 'cos', '2', 'α', '=', '2', 'cos', '2', 'α', '−', '1', '\n', 'f', '(', 'b', ')', '−', 'f', '(', 'a', ')',
 '=', 'f', '′', '(', 'ξ', ')', '(', 'b', '−', 'a', ')', ',', 'ξ', '∈', '(', 'a', ',', 'b', ')', '\n', '...', '\n']
```

用户输入特殊token当作普通标签处理，防止影响模型行为。

---

对比下LLaMA-2原版的分词结果：

```python
['▁', '<0x0A>', '<s>', '▁▁▁▁', '▁test', '▁▁▁▁', '</s>', '▁', '<0x0A>', '##', '#', '▁', '登', '<0xE9>', '<0xB9>',
 '<0xB3>', '<0xE9>', '<0x9B>', '<0x80>', '<0xE6>', '<0xA5>', '<0xBC>', '<0x0A>', '白', '日', '<0xE4>', '<0xBE>',
 '<0x9D>', '山', '<0xE5>', '<0xB0>', '<0xBD>', '，', '黄', '河', '入', '海', '流', '。', '<0xE6>', '<0xAC>', '<0xB2>',
 '<0xE7>', '<0xA9>', '<0xB7>', '千', '里', '目', '，', '更', '上', '一', '<0xE5>', '<0xB1>', '<0x82>', '<0xE6>',
 '<0xA5>', '<0xBC>', '。', '<0x0A>', '白', '日', 'は', '山', 'に', '<0xE6>', '<0xB2>', '<0xBF>', 'っ', 'て', '<0xE5>',
 '<0xB0>', '<0xBD>', 'き', '、', '黄', '河', 'は', '海', 'に', '流', 'れ', '<0xE8>', '<0xBE>', '<0xBC>', 'む', '。', '千',
 '里', 'の', '<0xE7>', '<0x9C>', '<0xBA>', 'め', 'を', '求', 'め', 'る', 'な', 'ら', '、', 'も', 'う', '一', '<0xE5>', '<0xB1>',
 '<0xA4>', 'の', '<0xE6>', '<0xA5>', '<0xBC>', 'に', '上', 'が', 'れ', '。', '<0x0A>', 'The', '▁sun', '▁beyond', '▁the',
 '▁mountain', '▁g', 'low', 's', '.', '▁The', '▁Y', 'ellow', '▁River', '▁sea', 'ward', '▁flows', '.', '▁You', '▁can',
 '▁enjoy', '▁a', '▁gr', 'ander', '▁sight', '.', '▁By', '▁clim', 'bing', '▁to', '▁a', '▁greater', '▁height', '.',
 '<0x0A>', 'if', '▁__', 'name', '__', '▁==', "▁'", '__', 'main', '__', "':", '<0x0A>', 'public', '▁static', '▁void',
 '▁main', '(', 'String', '[]', '▁args', ')', '▁{', '<0x0A>', '<', 'body', '><', 'h', '1', '>', '标', '题', '一', '</',
 'h', '1', '><', 'h', '2', '>', '标', '题', '二', '</', 'h', '2', '><', 'p', '>', '段', '<0xE8>', '<0x90>', '<0xBD>',
 '</', 'p', '></', 'body', '>', '<0x0A>', 'cos', '2', 'α', '=', '2', 'cos', '²', 'α', '−', '1', '<0x0A>', 'f', '(', 'b',
 ')', '−', 'f', '(', 'a', ')=', 'f', '′', '(', 'ξ', ')(', 'b', '−', 'a', '),', 'ξ', '∈', '(', 'a', ',', 'b', ')',
 '<0x0A>', '...', '<0x0A>']
```

原版词表里的汉字太少。“白日依山尽”这么简单一句，就有“依”和“尽”不在词表里。

---

再对比下Baichuan2的分词结果：

```python
['\n', '<s>', '▁▁▁', '▁test', '▁▁▁▁', '</s>', '\n', '###', '▁', '登', '鹳', '雀', '楼', '\n', '白日', '依山', '尽', '，',
 '黄河', '入', '海', '流', '。', '欲', '穷', '千里', '目', '，', '更上一层楼', '。', '\n', '白日', 'は', '山', 'に', '沿',
 'って', '尽', 'き', '、', '黄河', 'は', '海', 'に', '流', 'れ', '込', 'む', '。', '千里', 'の', '眺', 'め', 'を', '求', 'め', 'る',
 'な', 'ら', '、', 'も', 'う', '一', '層', 'の', '楼', 'に', '上', 'が', 'れ', '。', '\n', 'The', '▁sun', '▁beyond', '▁the',
 '▁mountain', '▁gl', 'ows', '.', '▁The', '▁Yellow', '▁River', '▁seaw', 'ard', '▁flows', '.', '▁You', '▁can', '▁enjoy',
 '▁a', '▁gr', 'ander', '▁sight', '.', '▁By', '▁climbing', '▁to', '▁a', '▁greater', '▁height', '.', '\n', 'if', '▁__',
 'name', '__', '▁', '=', '=', "▁'", '__', 'main', '__', "':", '\n', 'public', '▁static', '▁void', '▁main', '(',
 'String', '[]', '▁args', ')', '▁{', '\n', '<', 'body', '>', '<h1>', '标题', '一', '</h1>', '<h2>', '标题', '二',
 '</h2>', '<p>', '段落', '</p>', '</', 'body', '>', '\n', 'cos', '2', 'α', '=', '2', 'cos', '²', 'α', '−', '1', '\n',
 'f', '(', 'b', ')', '−', 'f', '(', 'a', ')', '=', 'f', '′', '(', 'ξ', ')(', 'b', '−', 'a', '),', 'ξ', '∈', '(', 'a',
 ',', 'b', ')', '\n', '...', '\n']
```

Baichuan编码非常高效。但其词表非常大，用了125K，而我们只有42K。